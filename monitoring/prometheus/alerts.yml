# Alert Rules for BofhContract Monitoring
#
# This file defines alerting rules for Prometheus to detect anomalies
# and issues in the BofhContract system.

groups:
  - name: bofh_gas_alerts
    interval: 30s
    rules:
      - alert: HighGasUsage
        expr: bofh_gas_used > 300000
        for: 2m
        labels:
          severity: warning
          component: swap-execution
        annotations:
          summary: "High gas usage detected"
          description: "Gas usage is {{ $value }} (threshold: 300,000). This may indicate inefficient swap paths or contract issues."

      - alert: ExtremeGasUsage
        expr: bofh_gas_used > 400000
        for: 1m
        labels:
          severity: critical
          component: swap-execution
        annotations:
          summary: "CRITICAL: Extreme gas usage detected"
          description: "Gas usage is {{ $value }} (threshold: 400,000). Immediate investigation required."

  - name: bofh_success_rate_alerts
    interval: 30s
    rules:
      - alert: LowSuccessRate
        expr: (bofh_successful_swaps / bofh_total_swaps) < 0.95
        for: 5m
        labels:
          severity: warning
          component: swap-execution
        annotations:
          summary: "Low swap success rate"
          description: "Success rate is {{ $value | humanizePercentage }}. Check pool liquidity and MEV protection settings."

      - alert: CriticalSuccessRate
        expr: (bofh_successful_swaps / bofh_total_swaps) < 0.90
        for: 2m
        labels:
          severity: critical
          component: swap-execution
        annotations:
          summary: "CRITICAL: Very low success rate"
          description: "Success rate is {{ $value | humanizePercentage }}. Consider pausing the contract."

  - name: bofh_price_impact_alerts
    interval: 30s
    rules:
      - alert: HighPriceImpact
        expr: bofh_price_impact_percent > 5.0
        for: 1m
        labels:
          severity: warning
          component: price-impact
        annotations:
          summary: "High price impact detected"
          description: "Price impact is {{ $value }}% (threshold: 5%). Review swap amounts and pool sizes."

      - alert: ExtremePriceImpact
        expr: bofh_price_impact_percent > 10.0
        for: 30s
        labels:
          severity: critical
          component: price-impact
        annotations:
          summary: "CRITICAL: Extreme price impact"
          description: "Price impact is {{ $value }}% (threshold: 10%). Immediate review required."

  - name: bofh_profitability_alerts
    interval: 1m
    rules:
      - alert: UnprofitableSwaps
        expr: rate(bofh_failed_swaps[5m]) / rate(bofh_successful_swaps[5m]) > 0.10
        for: 3m
        labels:
          severity: warning
          component: profitability
        annotations:
          summary: "High rate of unprofitable swaps"
          description: "Failed swap rate is {{ $value | humanizePercentage }} of successful swaps. Review fee structures and market conditions."

      - alert: NegativeTotalProfit
        expr: rate(bofh_total_profit_bnb[10m]) < 0
        for: 10m
        labels:
          severity: critical
          component: profitability
        annotations:
          summary: "CRITICAL: Negative total profit"
          description: "Cumulative profit is negative over the last 10 minutes. Consider pausing trading."

  - name: bofh_contract_state_alerts
    interval: 30s
    rules:
      - alert: ContractPaused
        expr: bofh_contract_paused == 1
        for: 1m
        labels:
          severity: warning
          component: contract-state
        annotations:
          summary: "Contract is paused"
          description: "BofhContract is in paused state. All swap operations are blocked."

      - alert: MEVProtectionDisabled
        expr: bofh_mev_protection_enabled == 0
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "MEV protection is disabled"
          description: "MEV protection has been disabled. Contract is vulnerable to MEV attacks."

      - alert: FrequentMEVProtectionTriggers
        expr: rate(bofh_mev_protection_triggers[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "Frequent MEV protection triggers"
          description: "MEV protection is triggering {{ $value }} times per second. Possible attack in progress."

  - name: bofh_system_health_alerts
    interval: 1m
    rules:
      - alert: IndexerDown
        expr: up{job="bofh-event-indexer"} == 0
        for: 1m
        labels:
          severity: critical
          component: indexer
        annotations:
          summary: "Event indexer is down"
          description: "The BofhContract event indexer service is not responding. Metrics collection has stopped."

      - alert: NoSwapActivity
        expr: rate(bofh_total_swaps[15m]) == 0
        for: 15m
        labels:
          severity: info
          component: activity
        annotations:
          summary: "No swap activity detected"
          description: "No swaps have been executed in the last 15 minutes. This may be normal during low activity periods."

      - alert: HighSwapRate
        expr: rate(bofh_total_swaps[1m]) > 10
        for: 5m
        labels:
          severity: info
          component: activity
        annotations:
          summary: "High swap rate detected"
          description: "Swap rate is {{ $value }} per second. System is experiencing high activity."

  - name: bofh_risk_parameter_alerts
    interval: 5m
    rules:
      - alert: MaxPriceImpactIncreased
        expr: bofh_max_price_impact > 150000  # 15% (PRECISION = 1e6)
        for: 5m
        labels:
          severity: warning
          component: risk-management
        annotations:
          summary: "Maximum price impact threshold increased"
          description: "Max price impact is now {{ $value }}. High-impact trades are now allowed."

      - alert: MinPoolLiquidityDecreased
        expr: bofh_min_pool_liquidity < 50000000  # 50 * PRECISION
        for: 5m
        labels:
          severity: warning
          component: risk-management
        annotations:
          summary: "Minimum pool liquidity threshold decreased"
          description: "Min pool liquidity is now {{ $value }}. Low-liquidity pools are now allowed."
