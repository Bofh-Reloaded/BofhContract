
> bofh-contract@1.5.0 test
> hardhat test

WARNING: You are currently using Node.js v25.1.0, which is not supported by Hardhat. This can lead to unexpected behavior. See https://v2.hardhat.org/nodejs-versions


duplicate definition - InvalidAddress()


  BofhContractV2
    Deployment & Initialization
      ✔ Should deploy with correct owner (91ms)
      ✔ Should set correct base token
      ✔ Should initialize with default risk parameters
      ✔ Should start in active (not paused) state
      ✔ Should reject deployment with zero address base token
    Access Control
      ✔ Should allow owner to update risk parameters
      ✔ Should prevent non-owner from updating risk parameters
      ✔ Should allow owner to pause contract
      ✔ Should prevent non-owner from pausing
      ✔ Should allow owner to unpause contract
      ✔ Should allow owner to transfer ownership
      ✔ Should prevent ownership transfer to zero address
    Input Validation
      ✔ Should reject swap with empty path
      ✔ Should reject swap with mismatched fees array length
      ✔ Should reject swap with zero input amount
      ✔ Should reject swap with zero minAmountOut
      ✔ Should reject swap with expired deadline
      ✔ Should reject swap with path not starting with base token
      ✔ Should reject swap with path not ending with base token
      ✔ Should reject swap with excessive fee
      ✔ Should reject path longer than maximum
    Risk Management
      ✔ Should enforce maximum price impact
      ✔ Should reject invalid max price impact (>100%)
      ✔ Should reject invalid sandwich protection (>10%)
      ✔ Should allow blacklisting pools
      ✔ Should prevent non-owner from blacklisting pools
      ✔ Should allow whitelisting previously blacklisted pools
    MEV Protection
      ✔ Should enforce deadline protection
      ✔ Should detect and prevent rapid successive transactions
    Emergency Controls
      ✔ Should prevent swaps when paused
      ✔ Should allow swaps after unpause
      ✔ Should update pause state correctly
      ✔ Should allow pause/unpause multiple times
    Event Emissions
      ✔ Should emit RiskParamsUpdated event
      ✔ Should emit PoolBlacklisted event
    View Functions
      ✔ Should return correct admin address
      ✔ Should return correct base token
      ✔ Should return risk parameters
      ✔ Should check if pool is blacklisted
    Reentrancy Protection
      ✔ Should prevent reentrancy attacks
    Gas Optimization
      ✔ Should execute swaps with reasonable gas usage
    Edge Cases
      ✔ Should handle minimum path length (2 addresses)
      ✔ Should handle very small amounts
      ✔ Should handle maximum uint256 approval

  Libraries
    MathLib
      sqrt
        ✔ Should return 0 for input 0
        ✔ Should calculate sqrt correctly for perfect squares
        ✔ Should calculate sqrt with reasonable precision for non-perfect squares
        ✔ Should handle large numbers
        ✔ Should handle very large numbers (> uint128)
      cbrt
        ✔ Should return 0 for input 0
        ✔ Should calculate cbrt correctly for perfect cubes
        ✔ Should calculate cbrt with reasonable precision for non-perfect cubes
        ✔ Should handle large numbers
      geometricMean
        ✔ Should return 0 if either input is 0
        ✔ Should calculate geometric mean for equal numbers
        ✔ Should calculate geometric mean correctly
        ✔ Should handle large numbers using log approximation
      log2
        ✔ Should return 0 for input 0
        ✔ Should calculate log2 correctly for powers of 2
      exp2
        ✔ Should return PRECISION for input 0
        ✔ Should calculate exp2 correctly for integer inputs
        ✔ Should return max uint256 for very large inputs
      calculateOptimalAmount
        ✔ Should reject invalid path lengths
        ✔ Should calculate amounts for 3-way swaps (equal distribution)
        ✔ Should calculate amounts for 4-way swaps (golden ratio)
        ✔ Should calculate amounts for 5-way swaps (golden ratio squared)
    PoolLib
      calculatePriceImpact
        ✔ Should return 0 for zero amount
        ✔ Should calculate price impact for small trades
        ✔ Should calculate higher impact for large trades
        ✔ Should handle edge case with imbalanced reserves
      calculateVolatility
        ✔ Should return existing volatility if no time passed
        ✔ Should return existing volatility if timestamps are reversed
        ✔ Should calculate volatility with time decay
      analyzePool
        ✔ Should analyze pool and return correct state for token0 trade
        ✔ Should analyze pool and return correct state for token1 trade
        ✔ Should revert for invalid token
      calculateOptimalSwapAmount
        ✔ Should revert if minimum output cannot be met (insufficient liquidity)
      validateSwap
        ✔ Should validate a valid swap
        ✔ Should reject expired deadline
        ✔ Should reject zero amount
        ✔ Should reject excessive price impact setting
        ✔ Should reject trade with actual high price impact
        ✔ Should reject pool with excessive volatility
        ✔ Should reject pool that is too shallow
    SecurityLib
      Access Control
        ✔ Should allow owner to perform owner-only actions
        ✔ Should prevent non-owner from performing owner-only actions
        ✔ Should transfer ownership correctly
        ✔ Should prevent ownership transfer to zero address
      Pause Mechanism
        ✔ Should allow owner to pause
        ✔ Should prevent non-owner from pausing
        ✔ Should block actions when paused
        ✔ Should allow owner to unpause
      Reentrancy Protection
        ✔ Should allow entering protected section
        ✔ Should prevent reentrant calls
        ✔ Should allow re-entry after exiting
      Rate Limiting
        ✔ Should allow actions within rate limit
        ✔ Should emit anomaly event when rate limit exceeded
      Operator Management
        ✔ Should allow owner to set operators
        ✔ Should prevent non-owner from setting operators
        ✔ Should prevent setting zero address as operator
      Value Bounds Checking
        ✔ Should accept values within bounds
        ✔ Should reject values below minimum
        ✔ Should reject values above maximum
      Deadline Validation
        ✔ Should accept deadline in future
        ✔ Should reject expired deadline
        ✔ Should accept deadline within grace period

  MEV Protection Tests
    configureMEVProtection
      ✔ Should configure MEV protection with valid parameters (74ms)
      ✔ Should emit MEVProtectionUpdated event
      ✔ Should allow disabling MEV protection
      ✔ Should reject zero maxTxPerBlock
      ✔ Should reject zero minTxDelay
      ✔ Should prevent non-owner from configuring MEV protection
    getMEVProtectionConfig
      ✔ Should return default MEV protection config
      ✔ Should return updated MEV protection config
    antiMEV modifier - Rate Limiting
      ✔ Should allow swap when MEV protection is disabled
      ✔ Should enforce minimum transaction delay when enabled
      ✔ Should allow transaction after delay period
      ✔ Should allow multiple transactions when MEV protection disabled
    MEV Protection Integration
      ✔ Should work with paused state

  Multi-Swap Execution Tests
    Profitability Enforcement
      ✔ Should reject unprofitable 2-path execution (56ms)
      ✔ Should reject unprofitable 3-path execution (77ms)
      ✔ Should reject unprofitable single path
    Input Validation
      ✔ Should reject empty paths array
      ✔ Should reject mismatched array lengths (paths vs fees)
      ✔ Should reject mismatched array lengths (paths vs amounts)
      ✔ Should reject mismatched array lengths (paths vs minAmounts)
      ✔ Should reject expired deadline
      ✔ Should reject zero deadline
    Edge Cases
      ✔ Should handle different path lengths in parallel

  Swap Execution Tests
    2-Way Swap Execution (BASE → A → BASE)
Swap successful, gas used: 218820
Balance before: 1000.0 Balance after: 999.94014949194366257
      ✔ Should execute simple 2-way swap successfully (143ms)
      ✔ Should revert if output is below minAmountOut
      ✔ Should emit SwapExecuted event
    3-Way Swap Execution (BASE → A → B → BASE)
      ✔ Should execute 3-way triangular arbitrage
      ✔ Should track cumulative price impact
    4-Way Swap Execution (Golden Ratio Optimization)
      ✔ Should execute 4-way swap with golden ratio splits
      ✔ Should apply golden ratio (φ ≈ 0.618) for amount distribution
      ✔ Should handle maximum path length (5 addresses)
    5-Way Swap Execution (Complex Optimization)
      ✔ Should execute 5-way swap (max path length)
      ✔ Should apply golden ratio squared (φ² ≈ 0.382) for 5-way splits
    Gas Consumption
      ✔ Should track gas usage per swap step
      ✔ Should have higher gas for longer paths
    Price Impact Validation
      ✔ Should revert if cumulative price impact exceeds maximum

  View Functions Tests
    getOptimalPathMetrics
      ✔ Should calculate metrics for 2-token path (65ms)
      ✔ Should calculate metrics for 3-token path
      ✔ Should calculate metrics for 4-token path
      ✔ Should show higher price impact for larger amounts
      ✔ Should show cumulative price impact increases with path length
      ✔ Should calculate optimality score correctly
      ✔ Should reject path with length < 2
      ✔ Should reject path with length > MAX_PATH_LENGTH
      ✔ Should handle maximum valid path length
    getBaseToken
      ✔ Should return correct base token address
    getFactory
      ✔ Should return correct factory address


  153 passing (940ms)

